#!/bin/bash
echo "
if [ $# != 2 ]
then
	printf "参数错误\n"
	exit 1
fi
ip=$2
if [ $2 == server ]
then
	printf "port 53 \nproto udp \ndev tun \nca /usr/share/easy-rsa/2.0/keys/ca.crt \ncert /usr/share/easy-rsa/2.0/keys/server.crt \nkey /usr/share/easy-rsa/2.0/keys/server.key \ndh /usr/share/easy-rsa/2.0/keys/dh2048.pem \ntls-auth /usr/share/easy-rsa/2.0/keys/ta.key 0 \nserver 10.8.0.0 255.255.255.0 \nifconfig-pool-persist ipp.txt \nsndbuf 0 \nrcvbuf 0 \npush \"redirect-gateway def1 bypass-dhcp\" \npush \"dhcp-option DNS 8.8.8.8\" \nkeepalive 10 120 \ncomp-lzo \nuser nobody \ngroup nobody \npersist-key \npersist-tun \nstatus /var/log/openvpn-status.log \nlog /var/log/openvpn.log \nverb 3">/etc/openvpn/server.conf
	ip=`curl ip.cip.cc`
fi

printf "client \ndev tun \nproto udp\nremote ${ip} 53\nresolv-retry infinite \nnobind \npersist-key \npersist-tun \nns-cert-type server \ncomp-lzo \nverb 3 \ntls-auth [inline] 1 \nsndbuf 0 \nrcvbuf 0 \npush \"dhcp-option DNS 10.8.0.1\" \npush \"dhcp-option WINS 10.8.0.0\" \npush \"redirect-geteway def1\" \n<ca>\n" >/root/$1.ovpn
cat ca.crt >> $1.ovpn
rm -rf ca.crt
printf "</ca>\n<cert>\n" >> $1.ovpn
cat $1.crt >> $1.ovpn
rm -rf $1.crt
printf "</cert>\n<key>\n" >> $1.ovpn
cat $1.key >> $1.ovpn
rm -rf $1.key
printf "</key>\n<tls-auth>\n" >> $1.ovpn
cat ta.key >> $1.ovpn
rm -rf ta.key
printf "</tls-auth>" >> $1.ovpn
">/dev/null

#设置防火墙和路由转发
ips={53 udp}

printf "输入监听端口及类型 [53 udp]:"
read -a ips
if [ ${#ips[@]} != 2 ]
then
	printf "输入错误\n"
	exit
fi

#检查发行版
issue=`cat /etc/issue|head -1`

if [ "${issue%%' '*}x" = "CentOSx" ]
then
	#检查sysctl.conf
	sysctl="/etc/sysctl.conf"
	if [ -f "$sysctl" ]
	then	
		sed -i '/^net.ipv4.ip_forward/c\net.ipv4.ip_forward=1' ${sysctl}
	else
		echo "net.ipv4.ip_forward=1" >${sysctl}
	fi
	#检查版本
	if [ ${issue:15:1} = "6" ]
	then
		iptables -I INPUT 1 -p ${ips[1]} --dport ${ips[0]} -j ACCEPT
		iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -j MASQUERADE -o eth0
		service iptables save
		service iptables restart
	else
		firewall-cmd --permanent --zone=public --add-port=${ips[0]}/${ips[1]}
		firewall-cmd --permanent --zone=public --add-masquerade
		firewall-cmd --permanent --zone=public --add-rich-rule='rule family=ipv4 source address=10.8.0.0/24 masquerade'
		firewall-cmd --reload
	fi
else
	echo "暂不支持非CentOS版本"
fi
